# Database Migrations with Alembic

This directory contains database migrations managed by Alembic.

## Quick Start

### Creating a new migration

1. **Auto-generate migration from model changes:**
   ```bash
   alembic revision --autogenerate -m "Description of changes"
   ```

2. **Create an empty migration:**
   ```bash
   alembic revision -m "Description of changes"
   ```

### Applying migrations

1. **Upgrade to the latest version:**
   ```bash
   alembic upgrade head
   ```

2. **Upgrade to a specific version:**
   ```bash
   alembic upgrade <revision>
   ```

3. **Downgrade by one version:**
   ```bash
   alembic downgrade -1
   ```

### Checking migration status

```bash
alembic current
alembic history
```

## How to Add a New Column

### Step 1: Update the Model

First, add the new column to your model in `src/database/models.py`:

```python
# Example: Adding a 'last_active' column to the User model
class User(Base):
    __tablename__ = "users"
    
    # ... existing columns ...
    
    # New column
    last_active = Column(DateTime, nullable=True)
```

### Step 2: Generate Migration

Run the auto-generate command to create a migration:

```bash
alembic revision --autogenerate -m "Add last_active column to users"
```

### Step 3: Review the Migration

Check the generated migration file in `alembic/versions/`. It should look something like:

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('last_active', sa.DateTime(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_column('last_active')
    # ### end Alembic commands ###
```

### Step 4: Apply the Migration

```bash
alembic upgrade head
```

## Common Scenarios

### Adding a Column with Default Value

```python
# In your model
status = Column(String(20), default="active", nullable=False)

# In the migration, you might need to handle existing rows:
def upgrade():
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('status', sa.String(20), nullable=False, server_default='active'))
```

### Adding an Index

```python
# In your model
email = Column(String(255), index=True)

# Migration will auto-generate the index creation
```

### Adding a Foreign Key

```python
# In your model
category_id = Column(Integer, ForeignKey('categories.id'))

# Migration will handle the foreign key constraint
```

## Important Notes

- The database URL is configured in `alembic.ini`
- Models are imported from `src.database.models`
- SQLite batch mode is enabled for proper ALTER TABLE support
- Always review auto-generated migrations before applying them
- For SQLite, some operations require batch mode (already configured)

## Troubleshooting

### "Table already exists" error
- Check current migration status: `alembic current`
- You might need to stamp the database: `alembic stamp head`

### Migration not detecting changes
- Make sure models are properly imported in `alembic/env.py`
- Check that all model classes inherit from `Base`

### SQLite limitations
- Some ALTER TABLE operations are limited in SQLite
- Batch mode helps, but complex changes might require table recreation

## Migration History

- `49b0dd082fa1` - Initial migration with whitelist table
  - Creates the `whitelist` table for database-based authorization
  - Adds index on `telegram_id` column

- `7c91f10cb583` - Add first_name and last_name to whitelist table
  - Adds `first_name` column to store user's first name
  - Adds `last_name` column to store user's last name