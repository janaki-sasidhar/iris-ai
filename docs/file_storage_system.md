# File Storage System Documentation

## Overview

The Telethon AI Bot now stores all images (both user-uploaded and AI-generated) in the local filesystem instead of the database. Only file paths are stored in the database, which significantly improves performance and reduces database size.

## Storage Structure

All files are stored under the base directory: `~/.telethon-bot-storage/` (in the user's home directory)

The directory structure is:
```
~/.telethon-bot-storage/
├── user_images/        # Images uploaded by users
├── generated_images/   # Images generated by AI models
└── temp/              # Temporary storage
```

**Note**: The storage location is in the home directory for better compatibility with WSL, Docker, and various deployment environments.

## File Naming Convention

- **User Images**: `{uuid}.{extension}` (e.g., `a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg`)
- **Generated Images**: `{uuid}.{extension}` (e.g., `f9e8d7c6-b5a4-3210-9876-543210fedcba.png`)

Files are named using UUIDs to ensure uniqueness and avoid conflicts.

## Database Schema Changes

The `messages` table has been updated:
- **Old**: `image_data` (TEXT) - stored base64 encoded images
- **New**: `image_path` (VARCHAR(500)) - stores the file system path

## Migration

If you have existing data with base64 images in the database, run the migration script:

```bash
python scripts/migrate_images_to_filesystem.py
```

This script will:
1. Create the necessary storage directories
2. Extract base64 images from the database
3. Save them to the filesystem
4. Update the database with file paths
5. Verify the migration was successful

## File Handling

### Uploading User Images

When a user sends an image:
1. The image is downloaded from Telegram
2. Saved to `/var/telethon-bot-storage/user_images/` with a UUID filename
3. The file path is stored in the database

### Generated Images

When AI generates images:
1. Images are initially saved to a temporary directory
2. When sending to the user, they're moved to `/var/telethon-bot-storage/generated_images/`
3. The permanent path is used for sending via Telegram

### Accessing Images

The `FileHandler` class provides methods to:
- Save user images: `save_user_image(image_bytes, mime_type)`
- Save generated images: `save_generated_image(source_path)`
- Read image bytes: `get_image_bytes(file_path)`
- Get base64 encoding: `get_image_base64(file_path)`
- Delete images: `delete_image(file_path)`

## Permissions

The storage directories are created with permissions `755` (rwxr-xr-x) to ensure:
- The bot can read/write files
- Other processes can read files if needed
- Security is maintained

## Backup Considerations

When backing up the bot:
1. Back up the database (contains file paths)
2. Back up the `~/.telethon-bot-storage/` directory (contains actual files)

Both are needed for a complete backup.

## Troubleshooting

### Permission Errors
If you encounter permission errors:
```bash
# The storage directory should be automatically created with proper permissions
# If needed, you can fix permissions:
chmod -R 755 ~/.telethon-bot-storage/
```

### Missing Images
The system handles missing images gracefully:
- If an image file is missing, the message is still included in the conversation
- The image data is simply omitted from the message sent to the LLM
- This prevents errors and ensures conversations continue working even if files are deleted

To verify missing file handling:
```bash
python scripts/test_missing_file_handling.py
```

If you need to check for missing images:
1. Check if the file exists at the path stored in the database
2. Verify permissions on the storage directory
3. Check disk space availability

### Migration Issues
If migration fails:
1. Check the error messages in the migration output
2. Ensure the storage directory can be created
3. Verify database connectivity
4. Run with `--verbose` flag for detailed logging

## Configuration

To change the storage location, modify `src/config/storage.py`:
```python
STORAGE_BASE_DIR = Path("/your/custom/path")
```

## Maintenance

### Cleaning Up Orphaned Files
Over time, you may accumulate orphaned files (files on disk with no database reference). To clean these up:

```python
# This is a conceptual example - implement as needed
async def cleanup_orphaned_files():
    # Get all file paths from database
    # Get all files from storage directories
    # Delete files not in database
```

### Disk Space Monitoring
Monitor the storage directory size:
```bash
du -sh ~/.telethon-bot-storage/
```

Set up alerts when disk usage exceeds thresholds.